---
title: "Checking Mixed Effects Model"
output: html_document
date: "2024-07-01"
---

```{r setup, include=FALSE, warning=F, message = F}
library(lme4)
library(tidyverse)
library(mvtnorm)

knitr::opts_chunk$set(echo = TRUE)
```


## Model

Mixed effects model with two fixed effects (including an intercept) and correlation within individual. 




$$y_{it} = \beta_0 + x_{it}\beta_1  +  \gamma_i + \epsilon_{it}$$
This is the matrix form with $3$ individuals and $2$ obserations per individual. 

\[
\begin{bmatrix}
y_{11} \\
y_{12} \\
y_{21} \\
y_{22} \\
y_{31} \\
y_{32}
\end{bmatrix} = 
\beta_0 \begin{bmatrix}
1 \\
1 \\
1 \\
1 \\
1 \\
1
\end{bmatrix} +\beta_1 \begin{bmatrix}
x_{11} \\
x_{12} \\
x_{21} \\
x_{22} \\
x_{31} \\
x_{32}
\end{bmatrix} + 
\begin{bmatrix}
1 & 0 & 0 \\
1 & 0 & 0 \\
0 & 1 & 0 \\
0 & 1 & 0 \\
0 & 0 & 1 \\
0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
\gamma_1 \\
\gamma_2 \\
\gamma_3
\end{bmatrix} +
\begin{bmatrix}
\epsilon_{11} \\
\epsilon_{12} \\
\epsilon_{21} \\
\epsilon_{22} \\
\epsilon_{31} \\
\epsilon_{32}
\end{bmatrix}
\]

with $\gamma_i \sim N(0, \sigma^2_\gamma)$ and $\epsilon_i \sim N(0, \sigma^2_\epsilon)$.

## Data Simulation Functions

First we need a function that produces the intra-individual correlation design matrix $\mathbf{Z}$:

```{r}
# get intra-individual correlation design matrix
# kronecker product produces this

generate_random_effects_block_matrix <- function(n, m) {
  
  # create a block of ones of size m x 1
  block <- matrix(1, nrow = m, ncol = 1)
  
  # get z matrix
  z <- kronecker(diag(n), block)
  
  return(z)
}

# test
generate_random_effects_block_matrix(3, 2)
```

We will generate data as follows:

$$\mathbf{x} = \begin{bmatrix} x_{11} \\
x_{12} \\
... \\
x_{1m} \\
... \\
x_{n1} \\
... \\
x_{nm}\\
\end{bmatrix} \sim MVN(0, I_{nm})$$

$\pmb{\gamma} \sim MVN(0, \sigma_u^2 I_n)$

$\pmb{\epsilon} \sim MVN(0, \sigma_e^2 I_{nm})$


```{r}
generate_data <- function(n, m, beta0, beta1, sigma_u, sigma_e) {
  #individual
  id <- rep(1:n, each = m)
  
  # design matrix
  x <- rmvnorm(m*n, mean = 0, diag(1))
  
  # random effects design matrix
  z <- generate_random_effects_block_matrix(n, m)
  
  # random effect
  u <- rmvnorm(n, 0, sigma_u * diag(1))
  
  # error
  epsilon <- rmvnorm(n*m, 0, sigma_e * diag(1))
  
  # calculate y
  y <- beta0 + beta1 * x + z %*% u + epsilon
  
  # return data
  data.frame(y = y, x = x, id = id)
}

# test
generate_data(n = 3, m = 2, beta0 = 1, beta1 = 2, sigma_u = 1, sigma_e = 1)
```


## Simulations

Note that I am running a mixed effects model with random intercept, but not random slope. 

```{r}
# simulation
simulation <- function(ns, m, beta0, beta1, sigma_u, sigma_e, num_simulations){
  
  # we want to construct a dataframe with number of individuals and
  # correlation for beta0 vs sigma_u, correlation for beta1 vs sigma_u
  
  out <- data.frame(n = rep(ns, each = 2), 
                    beta_vs_sigmau = rep(c("beta0_vs_sigmau", "beta1_vs_sigmau"),  length(ns)), 
                    corr = NA_real_)
  # repeat for each individual size n
  for(i in ns){
    
    # within each individual, repeat (1000?) times
    sims <- replicate(num_simulations, {
      
      # simulate data
      data <- generate_data(i, m, beta0, beta1, sigma_u, sigma_e)
      
      # fit model - this is random intercept, but not random slope
      # REML = F ensures we run ML not REML
      model <- lmer(y ~ x + (1 | id), data = data, REML = FALSE)
      
      # extract estimates
      return(c(beta_0 = fixef(model)[1], 
               beta1 = fixef(model)[2], 
               sigma_u = VarCorr(model)$id[1]))
    })
    
    # get correlations
    corrs <- cor(t(sims))
    
    # 2 is beta0 vs sigmau, 3 is beta1 vs sigmau
    corrs <- corrs[lower.tri(corrs)][2:3]
    
    # store values
    out[out$n == i, 3] <- corrs
    
  }
  
  gg <- ggplot(out, aes(x = n, group = beta_vs_sigmau, y = corr, color = beta_vs_sigmau)) + 
    geom_hline(yintercept = 0, color = "grey70", linetype = "dashed") +
    geom_line() + 
    geom_point() + 
    theme_minimal() + 
    labs(y = "Correlation", x = "Number of Individuals", color = "Comparison")
  
  print(gg)
  
}
```

For each number of individual $n = \{10,  25, 50, 75, 100, 150, 200, 250,  300, 350, 400, 450, 500\}$, we will generate data and fit our model 1000 times. Then we will take the correlation of those simulations. 


For each simulation, we fix that each individual has $m = 20$ observations and we will fix $\sigma_\epsilon^2 = 1$, $\beta_0 = 1$.

We will vary $\beta_1$ and $\sigma_\gamma^2$.


### Case 1: Equal Beta1 and sigma gamma

Here we set $\beta_1 = \sigma^2_\gamma = 1$.


```{r}
ns <- c(10,  25, 50, 75, 100, 150, 200, 250,  300, 350, 400, 450, 500)
nsims = 1000
m = 20
beta0 = 1
sigma_e = 1
set.seed(1)
```

```{r,eval = F}
sim0 <- simulation(n = ns, 
           m = m, beta0 = beta0, sigma_e = sigma_e,
           beta1 = 1, sigma_u = 1, 
           num_simulations =nsims)
saveRDS(sim0, file = "output/sim0.rds")
```

```{r}
readRDS(file ="output/sim0.rds" )
```


### Large Beta1 


Here we set $\beta_1 = 10$ and $\sigma^2_\gamma = 1$.


```{r, eval = F}
sim1 <- simulation(n =ns, m = m, beta0 = beta0, beta1 = 10, 
           sigma_u = 1, sigma_e = sigma_e, num_simulations =nsims)
saveRDS(sim1, file = "output/sim1.rds")

```

```{r}
readRDS(file ="output/sim1.rds" )
```

### Large sigma_u 

Here we set $\beta_1 = 1$ and $\sigma^2_\gamma = 10$.

```{r, eval = F}
sim2 <- simulation(n = ns, m = m, beta0 = beta0, beta1 = 1, 
           sigma_u = 10, sigma_e = sigma_e, num_simulations =nsims)
saveRDS(sim2, file = "output/sim2.rds")
```

```{r}
readRDS(file ="output/sim2.rds" )
```

### Large sigma_u and beta1

Here we set $\beta_1 = 10$ and $\sigma^2_\gamma = 10$.


```{r, eval = F}
sim3 <- simulation(n = ns, m = m, beta0 = beta0, beta1 = 10,
           sigma_u = 10, sigma_e = sigma_e, num_simulations =nsims)
saveRDS(sim3, file = "output/sim3.rds")
```

```{r}
readRDS(file ="output/sim3.rds" )
```

## Questions


- Sometimes I get errors regarding singular fit or failed to converge. I am not sure what this means or how to avoid it.

- I think I might try the mixed effects model with random intercept and random slope, to see if it makes a difference

- The take away is that $\sigma_\gamma^2$ and $\beta_1, \beta_0$ are correlated, but I am wondering if we should see a specific pattern as $n$ grows. For example, should we expect that as $n$ increase, correlation is stronger (and in one direction?
